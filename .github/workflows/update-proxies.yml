name: Update and Validate SG/MY Proxies

on:
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Python and dependencies
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install required packages
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Download and process proxies
      run: |
        set -e  # Exit on any error
        
        echo "üì• Downloading proxy list..."
        if ! wget -q -O proxy_list.csv "https://raw.githubusercontent.com/FoolVPN-ID/Nautica/refs/heads/main/proxyList.txt"; then
          echo "‚ùå Failed to download proxy list"
          exit 1
        fi
        
        # Check if file exists and has content
        if [ ! -s "proxy_list.csv" ]; then
          echo "‚ùå Downloaded file is empty or missing"
          exit 1
        fi
        
        echo "‚úÖ Downloaded $(wc -l < proxy_list.csv) lines"
        
        # Create header for proxies.txt
        echo "# Singapore & Malaysia Proxies" > proxies.txt
        echo "# Source: FoolVPN-ID/Nautica" >> proxies.txt
        echo "# Updated: $(date)" >> proxies.txt
        echo "" >> proxies.txt
        
        # Filter for SG and MY with better error handling
        echo "# üá∏üá¨ Singapore Proxies (SG)" >> proxies.txt
        if grep -q ",SG," proxy_list.csv; then
          grep ",SG," proxy_list.csv | sed 's/,/ : /g' | sed 's/,SG,/: Singapore |/g' >> proxies.txt
        else
          echo "# No SG proxies found" >> proxies.txt
        fi
        echo "" >> proxies.txt
        
        echo "# üá≤üáæ Malaysia Proxies (MY)" >> proxies.txt
        if grep -q ",MY," proxy_list.csv; then
          grep ",MY," proxy_list.csv | sed 's/,/ : /g' | sed 's/,MY,/: Malaysia |/g' >> proxies.txt
        else
          echo "# No MY proxies found" >> proxies.txt
        fi
        echo "" >> proxies.txt
        
        # Count and add statistics
        SG_COUNT=$(grep -c ",SG," proxy_list.csv || echo 0)
        MY_COUNT=$(grep -c ",MY," proxy_list.csv || echo 0)
        
        echo "# üìä Statistics" >> proxies.txt
        echo "# Singapore: $SG_COUNT" >> proxies.txt
        echo "# Malaysia: $MY_COUNT" >> proxies.txt
        echo "# Total: $((SG_COUNT + MY_COUNT))" >> proxies.txt
        
        echo "‚úÖ Processed $SG_COUNT SG proxies and $MY_COUNT MY proxies"
        
    - name: Create simple list for API testing
      run: |
        set -e
        
        echo "# Simple Proxy List for API Validation" > proxies_simple.txt
        echo "# Updated: $(date)" >> proxies_simple.txt
        echo "" >> proxies_simple.txt
        
        # Check if we have proxies to process
        if [ -f "proxy_list.csv" ] && [ -s "proxy_list.csv" ]; then
          # Extract IP:PORT using awk, only for SG and MY
          awk -F, '/,SG,|,MY,/ {if ($1 && $2) print $1 ":" $2}' proxy_list.csv >> proxies_simple.txt
          PROXY_COUNT=$(grep -c ':' proxies_simple.txt || echo 0)
          echo "üìÑ Created proxies_simple.txt with $PROXY_COUNT proxies"
        else
          echo "‚ö†Ô∏è No proxy data found, creating empty file"
          echo "# No proxies available" >> proxies_simple.txt
        fi
        
    - name: Validate proxies with API (Improved)
      run: |
        set -e
        echo "üîç Starting proxy validation..."
        
        # Initialize files
        echo "# üü¢ WORKING Proxies (API Validated)" > proxies_working.txt
        echo "# API: cf-workers-checkproxyip.pages.dev" >> proxies_working.txt
        echo "# Validated: $(date)" >> proxies_working.txt
        echo "" >> proxies_working.txt
        
        echo "# Simple Working Proxies" > proxies_working_simple.txt
        echo "# Validated: $(date)" >> proxies_working_simple.txt
        echo "" >> proxies_working_simple.txt
        
        TOTAL=0
        WORKING=0
        
        # Check if we have proxies to test
        if [ ! -f "proxies_simple.txt" ] || [ ! -s "proxies_simple.txt" ]; then
          echo "‚ö†Ô∏è No proxies to validate"
          echo "# No proxies to validate" >> proxies_working.txt
          exit 0
        fi
        
        # Count available proxies
        AVAILABLE_PROXIES=$(grep -v '^#' proxies_simple.txt | grep -c ':' || echo 0)
        echo "üìä Found $AVAILABLE_PROXIES proxies to test"
        
        # Test proxies (increased limit for better sampling)
        MAX_TEST=50
        TESTED=0
        
        while IFS= read -r proxy && [ $TESTED -lt $MAX_TEST ]; do
          [[ -z "$proxy" ]] && continue
          [[ "$proxy" =~ ^# ]] && continue
          
          TESTED=$((TESTED + 1))
          TOTAL=$((TOTAL + 1))
          echo "Testing [$TESTED/$MAX_TEST]: $proxy"
          
          # Test with timeout and better error handling
          start_time=$(date +%s%3N)
          API_RESPONSE=$(curl -s --max-time 15 --retry 1 "https://cf-workers-checkproxyip.pages.dev/check?proxyip=$proxy" 2>/dev/null || echo "ERROR")
          end_time=$(date +%s%3N)
          response_time=$((end_time - start_time))
          
          # Multiple success conditions
          if echo "$API_RESPONSE" | grep -q -E '"status":"alive"|"working":true|success|"alive":true'; then
            echo "$proxy | ${response_time}ms" >> proxies_working.txt
            echo "$proxy" >> proxies_working_simple.txt
            WORKING=$((WORKING + 1))
            echo "‚úÖ $proxy - ${response_time}ms"
          else
            echo "‚ùå $proxy - Failed or timeout"
          fi
          
          # Small delay to avoid rate limiting
          sleep 0.5
          
        done < <(grep -v '^#' proxies_simple.txt | head -$MAX_TEST)
        
        # Add statistics
        echo "" >> proxies_working.txt
        echo "# üìä Statistics" >> proxies_working.txt
        echo "# Total Tested: $TOTAL" >> proxies_working.txt
        echo "# Working: $WORKING" >> proxies_working.txt
        echo "# Dead: $((TOTAL - WORKING))" >> proxies_working.txt
        if [ $TOTAL -gt 0 ]; then
          SUCCESS_RATE=$((WORKING * 100 / TOTAL))
          echo "# Success Rate: ${SUCCESS_RATE}%" >> proxies_working.txt
        fi
        echo "# Validated: $(date)" >> proxies_working.txt
        
        echo "üéØ Validation complete: $WORKING working out of $TOTAL tested"
        
    - name: Create basic data.js
      run: |
        set -e
        echo "üìÅ Creating data.js..."
        
        # Get counts safely
        TOTAL=$(grep -v '^#' proxies_simple.txt | grep -c '^[0-9]' 2>/dev/null || echo 0)
        WORKING=$(grep -c '^[0-9]' proxies_working_simple.txt 2>/dev/null || echo 0)
        if [ $TOTAL -gt 0 ] && [ $WORKING -gt 0 ]; then
          SUCCESS_RATE=$((WORKING * 100 / TOTAL))
        else
          SUCCESS_RATE=0
        fi
        
        # Get some working proxies for the data file
        WORKING_PROXIES=$(head -10 proxies_working_simple.txt 2>/dev/null | grep -v '^#' | head -5 | tr '\n' ',' | sed 's/,$//' || echo "")
        
        cat > data.js << EOF
// data.js - Proxy Data Storage
const proxyData = {
    lastUpdated: "$(date -Iseconds)",
    countries: ['SG', 'MY'],
    totalProxies: $TOTAL,
    workingProxies: $WORKING,
    successRate: $SUCCESS_RATE,
    sampleProxies: [$WORKING_PROXIES],
    stats: {
        totalProxies: $TOTAL,
        workingProxies: $WORKING,
        successRate: $SUCCESS_RATE,
        lastValidation: "$(date -Iseconds)"
    }
};

// Export based on environment
if (typeof window !== 'undefined') window.proxyData = proxyData;
if (typeof module !== 'undefined' && module.exports) module.exports = proxyData;
EOF
        
        echo "‚úÖ data.js created with $TOTAL total, $WORKING working proxies"
      
    - name: Commit and push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Check if there are changes to commit
        if git diff --quiet && git diff --staged --quiet; then
          echo "ü§∑‚Äç‚ôÇÔ∏è No changes to commit"
          exit 0
        fi
        
        git add -A
        git commit -m "ü§ñ Auto-update: SG/MY proxies & data.js [$(date +%Y-%m-%d %H:%M)]"
        git push
