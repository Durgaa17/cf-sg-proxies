name: Update and Validate SG/MY Proxies

on:
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history
      
    - name: Install Python and dependencies
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install required packages
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Download and process proxies
      run: |
        set -e
        echo "ğŸ“¥ Downloading proxy list..."
        wget -q -O proxy_list.csv "https://raw.githubusercontent.com/FoolVPN-ID/Nautica/refs/heads/main/proxyList.txt" || echo "Download failed, continuing..."
        
        # Create proxies.txt
        echo "# Singapore & Malaysia Proxies" > proxies.txt
        echo "# Source: FoolVPN-ID/Nautica" >> proxies.txt
        echo "# Updated: $(date)" >> proxies.txt
        echo "" >> proxies.txt
        
        # Filter for SG and MY
        if [ -f "proxy_list.csv" ] && [ -s "proxy_list.csv" ]; then
          echo "# ğŸ‡¸ğŸ‡¬ Singapore Proxies (SG)" >> proxies.txt
          grep ",SG," proxy_list.csv | head -10 | sed 's/,/ : /g' | sed 's/,SG,/: Singapore |/g' >> proxies.txt
          echo "" >> proxies.txt
          
          echo "# ğŸ‡²ğŸ‡¾ Malaysia Proxies (MY)" >> proxies.txt
          grep ",MY," proxy_list.csv | head -10 | sed 's/,/ : /g' | sed 's/,MY,/: Malaysia |/g' >> proxies.txt
          echo "" >> proxies.txt
          
          SG_COUNT=$(grep -c ",SG," proxy_list.csv || echo 0)
          MY_COUNT=$(grep -c ",MY," proxy_list.csv || echo 0)
          echo "âœ… Processed $SG_COUNT SG proxies and $MY_COUNT MY proxies"
        else
          echo "# No proxy data available" >> proxies.txt
          echo "âš ï¸ No proxy data found"
        fi
        
    - name: Create simple list
      run: |
        echo "# Simple Proxy List" > proxies_simple.txt
        echo "# Updated: $(date)" >> proxies_simple.txt
        echo "" >> proxies_simple.txt
        
        if [ -f "proxy_list.csv" ] && [ -s "proxy_list.csv" ]; then
          awk -F, '/,SG,|,MY,/ {print $1 ":" $2}' proxy_list.csv | head -20 >> proxies_simple.txt
          echo "ğŸ“„ Created proxies_simple.txt"
        else
          echo "# No proxies available" >> proxies_simple.txt
          echo "ğŸ“„ Created empty proxies_simple.txt"
        fi
        
    - name: Pull latest changes before push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git pull origin main --rebase
        
    - name: Commit and push changes
      run: |
        git add proxies.txt proxies_simple.txt
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "ğŸ¤·â€â™‚ï¸ No changes to commit"
          exit 0
        fi
        
        git commit -m "ğŸ¤– Auto-update: SG/MY proxies [$(date +%Y-%m-%d %H:%M)]"
        git push origin main
