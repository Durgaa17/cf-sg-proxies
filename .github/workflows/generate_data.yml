name: ðŸ“Š Generate Data File

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Create data.js from working proxies
      run: |
        echo "ðŸ“ Creating data.js from validated proxies..."
        
        # Get counts from existing files
        if [ -f "proxies_working_simple.txt" ]; then
          WORKING_COUNT=$(grep -c '^[0-9]' proxies_working_simple.txt 2>/dev/null || echo 0)
          echo "Found $WORKING_COUNT working proxies"
        else
          WORKING_COUNT=0
          echo "No working proxies file found"
        fi
        
        if [ -f "proxies_simple.txt" ]; then
          TOTAL_COUNT=$(grep -c '^[0-9]' proxies_simple.txt 2>/dev/null || echo 0)
          echo "Found $TOTAL_COUNT total proxies"
        else
          TOTAL_COUNT=0
          echo "No proxies file found"
        fi
        
        # Calculate success rate
        if [ $TOTAL_COUNT -gt 0 ]; then
          SUCCESS_RATE=$((WORKING_COUNT * 100 / TOTAL_COUNT))
        else
          SUCCESS_RATE=0
        fi
        
        # Get sample proxies (first 5 working ones)
        if [ $WORKING_COUNT -gt 0 ]; then
          SAMPLE_PROXIES=$(grep '^[0-9]' proxies_working_simple.txt 2>/dev/null | head -5 | tr '\n' ' ' | sed 's/ /","/g' | sed 's/^/"/' | sed 's/""$//')
        else
          SAMPLE_PROXIES=""
        fi
        
        # Create data.js with proper formatting
        echo "// Proxy Data - Auto-generated" > data.js
        echo "// Updated: $(date)" >> data.js
        echo "" >> data.js
        echo "const proxyData = {" >> data.js
        echo "    lastUpdated: \"$(date -Iseconds)\"," >> data.js
        echo "    statistics: {" >> data.js
        echo "        totalProxies: $TOTAL_COUNT," >> data.js
        echo "        workingProxies: $WORKING_COUNT," >> data.js
        echo "        successRate: $SUCCESS_RATE," >> data.js
        echo "        lastValidation: \"$(date -Iseconds)\"" >> data.js
        echo "    }," >> data.js
        echo "    sampleProxies: [$SAMPLE_PROXIES]," >> data.js
        echo "    countries: [\"SG\", \"MY\"]" >> data.js
        echo "};" >> data.js
        echo "" >> data.js
        echo "// Export for different environments" >> data.js
        echo "if (typeof window !== 'undefined') window.proxyData = proxyData;" >> data.js
        echo "if (typeof module !== 'undefined' && module.exports) module.exports = proxyData;" >> data.js
        
        echo "âœ… data.js created:"
        echo "   - Total proxies: $TOTAL_COUNT"
        echo "   - Working proxies: $WORKING_COUNT" 
        echo "   - Success rate: $SUCCESS_RATE%"
        
    - name: Commit data file
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add data.js
        git commit -m "ðŸ“Š Update data.js [$(date +%H:%M)]" || echo "No changes to commit"
        git push
