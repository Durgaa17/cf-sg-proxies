name: ğŸ“Š Generate Data File

on:
  workflow_dispatch:
  schedule:
    - cron: '30 */2 * * *'  # 30 minutes past every 2 hours

permissions:
  contents: write

jobs:
  generate-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Create data.js from working proxies
      run: |
        echo "ğŸ“ Creating data.js from validated proxies..."
        
        # Get counts from existing files
        if [ -f "proxies_working_simple.txt" ]; then
          WORKING_COUNT=$(grep -c '^[0-9]' proxies_working_simple.txt 2>/dev/null || echo 0)
          echo "Found $WORKING_COUNT working proxies"
        else
          WORKING_COUNT=0
          echo "No working proxies file found"
        fi
        
        if [ -f "proxies_simple.txt" ]; then
          TOTAL_COUNT=$(grep -c '^[0-9]' proxies_simple.txt 2>/dev/null || echo 0)
          echo "Found $TOTAL_COUNT total proxies"
        else
          TOTAL_COUNT=0
          echo "No proxies file found"
        fi
        
        # Calculate success rate
        if [ $TOTAL_COUNT -gt 0 ]; then
          SUCCESS_RATE=$((WORKING_COUNT * 100 / TOTAL_COUNT))
        else
          SUCCESS_RATE=0
        fi
        
        # Get sample proxies (first 10 working ones)
        if [ $WORKING_COUNT -gt 0 ]; then
          SAMPLE_PROXIES=$(grep '^[0-9]' proxies_working_simple.txt 2>/dev/null | head -10 | tr '\n' ',' | sed 's/,$//')
        else
          SAMPLE_PROXIES=""
        fi
        
        # Create data.js
        cat > data.js << EOF
// Proxy Data - Auto-generated
// Updated: $(date)

const proxyData = {
    lastUpdated: "$(date -Iseconds)",
    statistics: {
        totalProxies: $TOTAL_COUNT,
        workingProxies: $WORKING_COUNT,
        successRate: $SUCCESS_RATE,
        lastValidation: "$(date -Iseconds)"
    },
    sampleProxies: [$SAMPLE_PROXIES],
    countries: ["SG", "MY"]
};

// Export for different environments
if (typeof window !== 'undefined') window.proxyData = proxyData;
if (typeof module !== 'undefined' && module.exports) module.exports = proxyData;
EOF
        
        echo "âœ… data.js created:"
        echo "   - Total proxies: $TOTAL_COUNT"
        echo "   - Working proxies: $WORKING_COUNT" 
        echo "   - Success rate: $SUCCESS_RATE%"
        echo "   - Sample proxies: $(echo "$SAMPLE_PROXIES" | tr ',' ' ' | wc -w)"
        
    - name: Commit data file
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add data.js
        git commit -m "ğŸ“Š Update data.js [$(date +%H:%M)]" || echo "No changes to commit"
        git push
