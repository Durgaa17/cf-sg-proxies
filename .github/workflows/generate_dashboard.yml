name: üìä Generate Dashboard

on:
  workflow_dispatch:
  schedule:
    - cron: '50 */2 * * *'  # Every 2 hours at :50

permissions:
  contents: write

jobs:
  generate-dashboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Generate dashboard
      run: |
        echo "üìä Generating proxy dashboard..."
        
        # Read current statistics
        if [ -f "stats/current-stats.json" ]; then
          TOTAL_PROXIES=$(grep '"total_proxies":' stats/current-stats.json | cut -d':' -f2 | tr -d ' ,')
          WORKING_PROXIES=$(grep '"working_proxies":' stats/current-stats.json | cut -d':' -f2 | tr -d ' ,')
          SUCCESS_RATE=$(grep '"success_rate":' stats/current-stats.json | cut -d':' -f2 | tr -d ' ,')
          LAST_UPDATED=$(grep '"last_updated":' stats/current-stats.json | cut -d'"' -f4)
        else
          TOTAL_PROXIES=0
          WORKING_PROXIES=0
          SUCCESS_RATE=0
          LAST_UPDATED="Never"
        fi
        
        # Get working proxies list
        if [ -f "proxies_working_simple.txt" ]; then
          # Extract just the proxy:port lines (no comments)
          grep '^[0-9]' proxies_working_simple.txt > working_proxies_temp.txt 2>/dev/null || echo "" > working_proxies_temp.txt
          WORKING_PROXIES_COUNT=$(grep -c '^[0-9]' proxies_working_simple.txt 2>/dev/null || echo 0)
        else
          echo "" > working_proxies_temp.txt
          WORKING_PROXIES_COUNT=0
        fi
        
        # Calculate additional metrics
        FAILED_PROXIES=$((TOTAL_PROXIES - WORKING_PROXIES))
        
        # Determine status color
        if [ $SUCCESS_RATE -ge 70 ]; then
          STATUS_COLOR="green"
          STATUS="Excellent"
        elif [ $SUCCESS_RATE -ge 40 ]; then
          STATUS_COLOR="orange" 
          STATUS="Good"
        else
          STATUS_COLOR="red"
          STATUS="Poor"
        fi
        
        # Create dashboard.html with copy functionality
        echo "<!DOCTYPE html>" > dashboard.html
        echo "<html lang='en'>" >> dashboard.html
        echo "<head>" >> dashboard.html
        echo "    <meta charset='UTF-8'>" >> dashboard.html
        echo "    <meta name='viewport' content='width=device-width, initial-scale=1.0'>" >> dashboard.html
        echo "    <title>SG/MY Proxy Dashboard</title>" >> dashboard.html
        echo "    <style>" >> dashboard.html
        echo "        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }" >> dashboard.html
        echo "        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }" >> dashboard.html
        echo "        .header { text-align: center; margin-bottom: 30px; }" >> dashboard.html
        echo "        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }" >> dashboard.html
        echo "        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #007bff; }" >> dashboard.html
        echo "        .stat-number { font-size: 2em; font-weight: bold; margin: 10px 0; }" >> dashboard.html
        echo "        .stat-label { color: #666; font-size: 0.9em; }" >> dashboard.html
        echo "        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; }" >> dashboard.html
        echo "        .status-green { background: #28a745; }" >> dashboard.html
        echo "        .status-orange { background: #ffc107; color: black; }" >> dashboard.html
        echo "        .status-red { background: #dc3545; }" >> dashboard.html
        echo "        .last-updated { text-align: center; color: #666; margin-top: 20px; }" >> dashboard.html
        echo "        .countries { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }" >> dashboard.html
        echo "        .country-flag { font-size: 2em; }" >> dashboard.html
        echo "        .proxies-section { margin-top: 40px; }" >> dashboard.html
        echo "        .proxies-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }" >> dashboard.html
        echo "        .proxies-list { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; font-family: monospace; }" >> dashboard.html
        echo "        .proxy-item { padding: 5px 0; border-bottom: 1px solid #eee; }" >> dashboard.html
        echo "        .proxy-item:last-child { border-bottom: none; }" >> dashboard.html
        echo "        .copy-btn { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }" >> dashboard.html
        echo "        .copy-btn:hover { background: #0056b3; }" >> dashboard.html
        echo "        .copy-btn:active { background: #004085; }" >> dashboard.html
        echo "        .copy-notification { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; display: none; }" >> dashboard.html
        echo "    </style>" >> dashboard.html
        echo "</head>" >> dashboard.html
        echo "<body>" >> dashboard.html
        echo "    <div class='copy-notification' id='copyNotification'>‚úÖ Copied to clipboard!</div>" >> dashboard.html
        echo "    <div class='container'>" >> dashboard.html
        echo "        <div class='header'>" >> dashboard.html
        echo "            <h1>üåè SG/MY Proxy Dashboard</h1>" >> dashboard.html
        echo "            <p>Real-time proxy statistics and monitoring</p>" >> dashboard.html
        echo "        </div>" >> dashboard.html
        echo "        " >> dashboard.html
        echo "        <div class='countries'>" >> dashboard.html
        echo "            <div class='country-flag'>üá∏üá¨ Singapore</div>" >> dashboard.html
        echo "            <div class='country-flag'>üá≤üáæ Malaysia</div>" >> dashboard.html
        echo "        </div>" >> dashboard.html
        echo "        " >> dashboard.html
        echo "        <div class='stats-grid'>" >> dashboard.html
        echo "            <div class='stat-card'>" >> dashboard.html
        echo "                <div class='stat-label'>Total Proxies</div>" >> dashboard.html
        echo "                <div class='stat-number'>$TOTAL_PROXIES</div>" >> dashboard.html
        echo "                <div>Available</div>" >> dashboard.html
        echo "            </div>" >> dashboard.html
        echo "            " >> dashboard.html
        echo "            <div class='stat-card'>" >> dashboard.html
        echo "                <div class='stat-label'>Working Proxies</div>" >> dashboard.html
        echo "                <div class='stat-number' style='color: #28a745;'>$WORKING_PROXIES</div>" >> dashboard.html
        echo "                <div>Verified</div>" >> dashboard.html
        echo "            </div>" >> dashboard.html
        echo "            " >> dashboard.html
        echo "            <div class='stat-card'>" >> dashboard.html
        echo "                <div class='stat-label'>Success Rate</div>" >> dashboard.html
        echo "                <div class='stat-number'>$SUCCESS_RATE%</div>" >> dashboard.html
        echo "                <div>Reliability</div>" >> dashboard.html
        echo "            </div>" >> dashboard.html
        echo "            " >> dashboard.html
        echo "            <div class='stat-card'>" >> dashboard.html
        echo "                <div class='stat-label'>Failed Proxies</div>" >> dashboard.html
        echo "                <div class='stat-number' style='color: #dc3545;'>$FAILED_PROXIES</div>" >> dashboard.html
        echo "                <div>Not Working</div>" >> dashboard.html
        echo "            </div>" >> dashboard.html
        echo "        </div>" >> dashboard.html
        echo "        " >> dashboard.html
        echo "        <div style='text-align: center; margin: 30px 0;'>" >> dashboard.html
        echo "            <div>System Status:</div>" >> dashboard.html
        echo "            <div class='status-badge status-$STATUS_COLOR'>$STATUS</div>" >> dashboard.html
        echo "        </div>" >> dashboard.html
        echo "        " >> dashboard.html
        echo "        <!-- WORKING PROXIES LIST -->" >> dashboard.html
        echo "        <div class='proxies-section'>" >> dashboard.html
        echo "            <div class='proxies-header'>" >> dashboard.html
        echo "                <h2>‚úÖ Working Proxies ($WORKING_PROXIES_COUNT verified)</h2>" >> dashboard.html
        echo "                <button class='copy-btn' onclick='copyAllProxies()'>üìã Copy All</button>" >> dashboard.html
        echo "            </div>" >> dashboard.html
        echo "            <div class='proxies-list' id='proxiesList'>" >> dashboard.html
        
        # Add each working proxy to the list
        if [ -s "working_proxies_temp.txt" ]; then
          while IFS= read -r proxy; do
            if [ ! -z "$proxy" ]; then
              echo "                <div class='proxy-item'>$proxy</div>" >> dashboard.html
            fi
          done < working_proxies_temp.txt
        else
          echo "                <div style='text-align: center; color: #666; padding: 20px;'>No working proxies available</div>" >> dashboard.html
        fi
        
        echo "            </div>" >> dashboard.html
        echo "        </div>" >> dashboard.html
        echo "        " >> dashboard.html
        echo "        <div class='last-updated'>" >> dashboard.html
        echo "            Last updated: $LAST_UPDATED" >> dashboard.html
        echo "        </div>" >> dashboard.html
        echo "        " >> dashboard.html
        echo "        <div style='text-align: center; margin-top: 30px; color: #666;'>" >> dashboard.html
        echo "            <p>Auto-generated by GitHub Actions ‚Ä¢ Updates every 2 hours</p>" >> dashboard.html
        echo "        </div>" >> dashboard.html
        echo "    </div>" >> dashboard.html
        echo "    " >> dashboard.html
        echo "    <script>" >> dashboard.html
        echo "        function copyAllProxies() {" >> dashboard.html
        echo "            const proxyItems = document.querySelectorAll('.proxy-item');" >> dashboard.html
        echo "            let proxyText = '';" >> dashboard.html
        echo "            proxyItems.forEach(item => {" >> dashboard.html
        echo "                if (item.textContent.trim()) {" >> dashboard.html
        echo "                    proxyText += item.textContent + '\\n';" >> dashboard.html
        echo "                }" >> dashboard.html
        echo "            });" >> dashboard.html
        echo "            " >> dashboard.html
        echo "            if (proxyText) {" >> dashboard.html
        echo "                navigator.clipboard.writeText(proxyText.trim()).then(() => {" >> dashboard.html
        echo "                    showCopyNotification();" >> dashboard.html
        echo "                });" >> dashboard.html
        echo "            }" >> dashboard.html
        echo "        }" >> dashboard.html
        echo "        " >> dashboard.html
        echo "        function showCopyNotification() {" >> dashboard.html
        echo "            const notification = document.getElementById('copyNotification');" >> dashboard.html
        echo "            notification.style.display = 'block';" >> dashboard.html
        echo "            setTimeout(() => {" >> dashboard.html
        echo "                notification.style.display = 'none';" >> dashboard.html
        echo "            }, 2000);" >> dashboard.html
        echo "        }" >> dashboard.html
        echo "    </script>" >> dashboard.html
        echo "</body>" >> dashboard.html
        echo "</html>" >> dashboard.html
        
        # Cleanup temp file
        rm -f working_proxies_temp.txt
        
        echo "‚úÖ Dashboard generated with $WORKING_PROXIES_COUNT working proxies"
        
    - name: Commit dashboard
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add dashboard.html
        git commit -m "üìä Update dashboard with proxy list [$(date +%H:%M)]" || echo "No changes to commit"
        git push
