name: Update Singapore & Malaysia Proxies

on:
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours
  workflow_dispatch:

permissions:
  contents: write  # THIS IS CRITICAL!

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Fetch and filter proxies
      run: |
        echo "# üöÄ Singapore & Malaysia Proxies" > proxies.txt
        echo "# Source: FoolVPN-ID/Nautica" >> proxies.txt
        echo "# Updated: $(date +'%Y-%m-%d %H:%M:%S')" >> proxies.txt
        echo "# Countries: SG (Singapore), MY (Malaysia)" >> proxies.txt
        echo "" >> proxies.txt
        
        echo "üîç Fetching proxies from source..."
        curl -s "https://raw.githubusercontent.com/FoolVPN-ID/Nautica/refs/heads/main/proxyList.txt" > temp_proxies.csv
        
        echo "üìä Processing proxies..."
        SG_COUNT=0
        MY_COUNT=0
        
        # Process the CSV file
        while IFS=, read -r ip port country provider; do
          # Clean up the values
          ip=$(echo "$ip" | xargs)
          port=$(echo "$port" | xargs)
          country=$(echo "$country" | xargs | tr '[:lower:]' '[:upper:]')
          provider=$(echo "$provider" | xargs)
          
          if [ "$country" = "SG" ]; then
            echo "$ip:$port | Singapore | $provider" >> proxies.txt
            SG_COUNT=$((SG_COUNT + 1))
          elif [ "$country" = "MY" ]; then
            echo "$ip:$port | Malaysia | $provider" >> proxies.txt
            MY_COUNT=$((MY_COUNT + 1))
          fi
        done < temp_proxies.csv
        
        echo "" >> proxies.txt
        echo "# üìä Statistics" >> proxies.txt
        echo "# Singapore (SG): $SG_COUNT" >> proxies.txt
        echo "# Malaysia (MY): $MY_COUNT" >> proxies.txt
        echo "# Total: $((SG_COUNT + MY_COUNT))" >> proxies.txt
        echo "# Last Update: $(date +'%Y-%m-%d %H:%M:%S')" >> proxies.txt
        
        echo "‚úÖ Found $SG_COUNT Singapore proxies and $MY_COUNT Malaysia proxies"
        
    - name: Create simple version
      run: |
        echo "# Simple Singapore & Malaysia Proxy List" > proxies_simple.txt
        echo "# Updated: $(date +'%Y-%m-%d %H:%M:%S')" >> proxies_simple.txt
        echo "# Extract from: FoolVPN-ID/Nautica" >> proxies_simple.txt
        echo "" >> proxies.txt
        
        # Extract IP:PORT only
        grep "| Singapore |" proxies.txt | cut -d'|' -f1 | sed 's/ //g' >> proxies_simple.txt
        grep "| Malaysia |" proxies.txt | cut -d'|' -f1 | sed 's/ //g' >> proxies_simple.txt
        
        SIMPLE_COUNT=$(grep -c ":" proxies_simple.txt || true)
        echo "üìÅ Simple version created with $SIMPLE_COUNT proxies"
        
    - name: Commit and push changes
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        git add proxies.txt proxies_simple.txt
        
        # Check if there are changes
        if ! git diff --staged --quiet; then
          git commit -m "ü§ñ Auto-update: SG/MY proxies [$(date +'%H:%M')]"
          git push
          echo "‚úÖ Successfully committed and pushed changes"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi
