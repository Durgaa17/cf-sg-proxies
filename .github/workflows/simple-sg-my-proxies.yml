name: Update Singapore & Malaysia Proxies

on:
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Fetch and process proxies
      run: |
        echo "üîç Downloading proxy list..."
        curl -s "https://raw.githubusercontent.com/FoolVPN-ID/Nautica/refs/heads/main/proxyList.txt" -o proxy_list.csv
        
        echo "üìä Creating proxy files..."
        
        # Create the main proxy file with header
        cat > proxies.txt << 'EOF'
# üöÄ Singapore & Malaysia Proxies
# Source: FoolVPN-ID/Nautica
# Updated: $(date)
# Countries: SG (Singapore), MY (Malaysia)

EOF

        # Process the CSV file safely
        SG_COUNT=0
        MY_COUNT=0
        
        while IFS= read -r line; do
          # Skip empty lines
          [[ -z "$line" ]] && continue
          
          # Split by comma
          IFS=, read -r ip port country provider <<< "$line"
          
          # Clean and uppercase country code
          country_clean=$(echo "$country" | tr '[:lower:]' '[:upper:]' | tr -d ' ' | tr -d '"')
          
          if [ "$country_clean" = "SG" ]; then
            echo "$ip:$port | Singapore | $provider" >> proxies.txt
            SG_COUNT=$((SG_COUNT + 1))
          elif [ "$country_clean" = "MY" ]; then
            echo "$ip:$port | Malaysia | $provider" >> proxies.txt
            MY_COUNT=$((MY_COUNT + 1))
          fi
        done < proxy_list.csv
        
        # Add statistics
        cat >> proxies.txt << EOF

# üìä Statistics
# Singapore (SG): $SG_COUNT
# Malaysia (MY): $MY_COUNT
# Total Proxies: $((SG_COUNT + MY_COUNT))
# Last Update: $(date)
EOF

        echo "‚úÖ Found $SG_COUNT Singapore proxies and $MY_COUNT Malaysia proxies"
        
    - name: Create simple version
      run: |
        echo "üìÅ Creating simple version..."
        
        cat > proxies_simple.txt << 'EOF'
# Simple Singapore & Malaysia Proxy List
# Source: FoolVPN-ID/Nautica
# Updated: $(date)
# Format: IP:PORT

EOF

        # Extract just IP:PORT from the main file
        grep -E '^[0-9]' proxies.txt | cut -d'|' -f1 | sed 's/ //g' >> proxies_simple.txt
        
        SIMPLE_COUNT=$(grep -c '^[0-9]' proxies_simple.txt || true)
        echo "üìÑ Simple version has $SIMPLE_COUNT proxies"
        
    - name: Commit and push changes
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        git add proxies.txt proxies_simple.txt
        
        if ! git diff --staged --quiet; then
          git commit -m "ü§ñ Auto-update: SG/MY proxies [$(date +'%H:%M')]"
          git push
          echo "‚úÖ Changes committed successfully"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi
